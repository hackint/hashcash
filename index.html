<!DOCTYPE html>
<html lang="en">
<head>
    <title>hackint - communication network for the hacker community</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/hackint.css">
</head>

<body>
<div class="box">
    <pre>
                 __               __
                / /_  ____ ______/ /__
               / __ \/ __ `/ ___/ //_/
              / / / / /_/ / /__/ ,&lt;            __
             /_/ /_/\__,_/\___/_/|_|  (*)___  / /_
                                     / / __ \/ __/
                                    / / / / / /_
             http://www.hackint.eu /_/_/ /_/\__/ 
             http://www.hackint.org
             http://www.hackint.net
    </pre>
</div>

<h2>Hashcash - Anonymous Registration</h2>

<div class="box">
    <p><strong>Note: You need to have session cookies enabled for this to work! If you do not have session cookies
        enabled, change your settings and reload this page!</strong></p>

    <p id="content">
        G&apos;day! We wish your stay at hackint to be a pleasant
        one. Unfortunately, completely anonymous access can be and is
        being abused regularily. Ironically, in order to preserve
        anonymous access, we have to introduce a <strong>cost</strong>
        that each user wishing to stay anonymous has to pay before they
        can access hackint. This cost is paid for by means
        of <strong>computation time</strong>. All you have to do
        is <strong>keep this website open for a few hours</strong> and
        once the calculations are finished, you will be able to create a
        nickserv user on hackint using a web form. You can then use
        this account to connect to hackint through SASL authentication.
    </p>

    <div id="error" style="display:none;">
        <h3 style="color:darkred !important;">Error</h3>
        <p id="errmsg"></p>
    </div>

    <div id="monitor" style="display:none;">
        <h3>Generating proof-of-work...</h3>

        <div id="workers"></div>
    </div>

    <div id="registration" style="display:none;">
        <h3>Registration</h3>

        <p>
            Thank you very much for your patience. You may now register an
            account on hackint. Please pick an accountname and a password.
        </p>
        <div style="max-width: 200px;">
            <form id="frmRegister">
                <input type="hidden" name="proof" value="Patience, young padawan" id="proof" />
                <div class="form-group">
                    <label for="txtAccountName">Accountname:</label>
                    <input type="text" class="form-control disabled" name="accountname" value="" id="txtAccountName" disabled/>
                </div>
                <div class="form-group">
                    <label for="txtPassword">Password:</label>
                    <input type="password" class="form-control disabled" name="password" value="" id="txtPassword" disabled/>
                </div>
                <div>
                    <button type="button" class="btn btn-success" id="btnRegister"  disabled>Register</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="js/jquery-2.1.3.min.js"></script>
<script type="text/javascript">
    $(function () {
        var error = function(errmsg) {
            $('#errmsg').html(errmsg);
            $('#error').show();
        };

        var accept = function (resp) {
            var chunks = resp.split(":", 2);

            if (chunks[0] == "error") {
                error(chunks[1]);
                return;
            }
            if (chunks[1] == "purchase ok") {
                $('#txtAccountName').prop('disabled', false);
                $('#txtPassword').prop('disabled', false);
                $('#btnRegister').prop('disabled', false);
                $("#registration").show();
            }
        };

        // hashcash register form - submit action
        $("#btnRegister").bind("click", function () {
            $.ajax({
                url: "/hashcash/register.php",
                type: "POST",
                data: {
                    username: $("#txtAccountName").val(),
                    password: $("#txtPassword").val()
                }
            }).done(function (resp) {
                var chunks = resp.split(":");

                if (chunks[0] == "error") {
                    error(chunks[1]);
                } else if (chunks[0] == "ok") {
                    // alert(chunks[1]);
                    window.location = "http://www.hackint.org/ihashcashok.html";
                } else {
                    error("Unexpected server response");
                }
            });
        });

        window.setInterval(function () {
            // keep session alive
            jQuery.ajax({url: "/hashcash/keepalive.php", type: "GET"});
        }, 60000);

        $.ajax({
            url: "/hashcash/backend.php",
            type: "GET",
            data: {action: "order"}
        }).done(function (resp) {
            console.log(resp);
            var chunks = resp.split(":", 2);

            if (chunks[0] == "error") {
                error(chunks[1]);
                return;
            }

            var parts = chunks[1].split(";");
            var salt = parts[0];
            var payload = parts[1];
            var numRounds = parseInt(parts[2]);
            
            var workers = [];
            var workerCount = navigator.hardwareConcurrency || 4; // not supported in firefox, fallback to 4 threads
            var workSize = 1000000;
            var perWorker = workSize / workerCount;

            var onMessageFunction = function (pid) {
                return function (resp) {
                    console.log("[#" + pid + "] " + resp.data['event'] + ": " + resp.data['text']);
                    if (resp.data["event"] == "finished") {
                        var proof = resp.data["value"].toString();
                        // insert proof
                        $('#proof').val(proof);
                        // hide worker monitor
                        $('#monitor').hide();
                        // enable form
                        $('#txtAccountName').prop('disabled', false);
                        $('#txtPassword').prop('disabled', false);
                        $('#btnRegister').prop('disabled', false);
                        $('#registration').show();
                        jQuery.ajax({
                            url: "/hashcash/backend.php",
                            type: "GET",
                            data: {
                                action: "purchase",
                                secret: proof
                            }
                        }).done(accept);

                        // Terminate Workers
                        for (var i = 0; i < workers.length; i++) {
                            console.log("Terminating Worker #" + i);
                            workers[i].terminate();
                        }
                    } else if (resp.data["event"] == "progress") {
                        // Update Worker Progress
                        $('#' + pid).html(resp.data["text"]);
                    }
                };
            };

            // Create Workers
            for (var i = 0; i < workerCount; i++) {
                console.log("Starting Worker #" + i);

                // view
                var view = document.createElement('div');

                var title = document.createElement('span');
                title.className = 'worker';
                title.textContent = "Worker #" + i;
                view.appendChild(title);

                var progress = document.createElement('div');
                progress.id = 'progress' + i;
                view.appendChild(progress);

                document.getElementById('workers').appendChild(view);

                // worker
                var worker = new Worker("js/hashcash.js");
                worker.postMessage([salt, payload, perWorker * i, perWorker * (i + 1), numRounds]);
                worker.onmessage = onMessageFunction("progress" + i.toString());
                workers.push(worker);
            }

            $('#monitor').show();
        });
    });
</script>
</body>
</html>

